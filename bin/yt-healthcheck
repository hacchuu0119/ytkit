#!/usr/bin/perl

########################################################################
# Copyright (C) 2017, 2018  yoku0825
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
########################################################################

use strict;
use warnings;
use utf8;
use Pod::Usage;

use FindBin qw/$Bin/;
use lib "$Bin/../lib";
use Ytkit::HealthCheck;

my $prog= Ytkit::HealthCheck->new(@ARGV);

if ($prog == -255)
{
  pod2usage({ -verbose => 2 });
  exit 0;
}
elsif ($prog == -254)
{
  printf("%s - %s\n", $0, Ytkit::Config::version());
  exit 0;
}

$prog->result;


__END__

=encoding utf8

=head1 SCRIPT NAME

yt-health-check - MySQL healthcheck script

=head1 SYNOPSIS

  $ yt-healthcheck --host=your_mysql_host --port=your_mysql_port --user=your_mysql_account --password=your_password

=head1 DESCRIPTION

yt-health-check checks following MySQL status,

  Able to connect.
  Running replication threads.
  Replication delay.
  Too long query in processlist.
  Connection count.
  AUTO_INCREMENT column usage.
  read_only variable is set or not.

and returns Nagios compatible result code,

  0 OK
  1 WARNING
  2 CRITICAL
  3 UNKNOWN

=head1 OPTIONS

=head2 --role={master,slave,backup,intermidiate,auto,fabric,none}

Switching check-item as below,

=over 8

=item "master"

=over 1

=item - Long query

=item - Connection count

=item - AUTO_INCREMENT usage

=item - read_only should be OFF

=back

=item "slave"

=over 1

=item - Long query

=item - Replication threads

=item - Replication delay

=item - Connection count

=item - read_only should be ON

=back

=item "intermidiate"

=over 1

=item - Long query

=item - Connection count

=item - AUTO_INCREMENT usage

=item - Replication threads

=item - Replication delay

=item - read_only should be OFF

=back

=item "backup"

=over 1

=item - Replication threads

=item - read_only should be ON

=back

=item "auto"

Script determines MySQL is "master", "slave" or "intermidiate" automatically by using SHOW SLAVE STATUS and SHOW SLAVE HOSTS(Result is empty or not)

=item "none"

Check only connectivity. For calling as library.

=item "fabric"

Checking for mikasafabric for MySQL.

=back

=head2 --host=string, -h string

MySQL host.

=head2 --port=integer, -P integer

MySQL port number.

=head2 --socket=string, -S string

Path to mysql.sock (this parameter is used when --host=localhost)

=head2 --user=string, -u string

MySQL account using for connection and checking
(need REPLICATION CLIENT and PROCESSLIST and global SELECT priv)

=head2 --password=string, -p string

Password for the user specified by --user

=head2 --timeout=int

Seconds before timeout(read_timeout, write_timeout, connect_timeout)

=head2 --long-query-enable=0

Turn off SHOW PROCESSLIST's check.

=head2 --long-query-warning=integer, --long-query-critical=integer

Threshold for `SHOW PROCESSLIST`'s `Time`.

=head2 --long-query-exclude-host=string[,string,..]

Comma seperated values for `SHOW PROCESSLIST`'s `Host`.
When first-match them, doesn't raise WARNING or CRITICAL(always OK)

=head2 --long-query-exclude-query=string[,string,..]

Comma seperated values for `SHOW PROCESSLIST`'s `Info`(SQL statement)
When first-match them, doesn't raise WARNING or CRITICAL(always OK)

=head2 --connection-count-enable=0

Turn off connection count check.

=head2 --connection-count-warning=integer, --connection-count-critical=integer

Threshold for `Threads_connected / max_connections`. Unit is %.

=head2 --autoinc-usage-enable=0

Turn off autoinc usage calculation.

=head2 --autoinc-usage-warning=integer, --autoinc-usage-critical=integer

Threshold for `auto_increment / datatype_max`. Unit is %.

=head2 --slave-status-enable=0

Turn off `SHOW SLAVE STATUS`

=head2 --slave-status-warning=integer, --slave-status-critical=integer

Threshold for `SHOW SLAVE STATUS`'s `Seconds_Behind_Master`.

=head2 --fabric-fd-enable=0

Turn off mikasafabric's `CALL manage.openfds()`

=head2 --fabric-fd-warning=integer, --fabric-fd-critical=integer

Threshold for mikasafabric's `current_fd / max_fd`. Unit is %.

=cut
